<!DOCTYPE html>
<html>
<head>
    <title>Debug Messages</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .debug-section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Message System Debug - Fixed Version</h1>
    
    <div class="debug-section">
        <h2>1. Current User Info</h2>
        <div id="userInfo">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h2>2. Test Send Message</h2>
        <p>Send a test message from current user to another user.</p>
        <div>
            <input type="text" id="testUserId" placeholder="Enter receiver user ID" style="width: 300px;">
        </div>
        <div style="margin: 10px 0;">
            <input type="text" id="testMessage" placeholder="Enter test message" style="width: 300px;">
        </div>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <div id="sendResult"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. Check All Messages in Database</h2>
        <button onclick="checkAllMessages()">Check All Messages</button>
        <div id="allMessages"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. Check Current User's Messages</h2>
        <button onclick="checkMyMessages()">Check My Messages</button>
        <div id="myMessages"></div>
    </div>
    
    <div class="debug-section">
        <h2>5. Create Test Message</h2>
        <p>Create a test message between two test users.</p>
        <button onclick="createTestMessage()">Create Test Message</button>
        <div id="testMessageResult"></div>
    </div>
    
    <div class="debug-section">
        <h2>6. Check All Users</h2>
        <button onclick="checkAllUsers()">List All Users</button>
        <div id="allUsers"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // Use existing Firebase instance (already initialized in firebase-config.js)
        let currentUser = null;
        let db = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Debug page loading...");
            
            // Wait a moment for Firebase to initialize
            setTimeout(() => {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    db = firebase.firestore();
                    
                    // Listen for auth state
                    firebase.auth().onAuthStateChanged((user) => {
                        currentUser = user;
                        updateUserInfo();
                        
                        if (user) {
                            console.log("✅ User logged in:", user.uid);
                            // Automatically check messages
                            setTimeout(() => checkMyMessages(), 1000);
                        } else {
                            console.log("❌ No user logged in");
                        }
                    });
                } else {
                    document.getElementById('userInfo').innerHTML = 
                        '<p class="error">Firebase not initialized. Check firebase-config.js</p>';
                }
            }, 1000);
        });
        
        function updateUserInfo() {
            const container = document.getElementById('userInfo');
            if (!currentUser) {
                container.innerHTML = '<p class="error">Not logged in</p>';
                return;
            }
            
            container.innerHTML = `
                <p><strong>User ID:</strong> ${currentUser.uid}</p>
                <p><strong>Email:</strong> ${currentUser.email || 'No email'}</p>
                <button onclick="logout()">Logout</button>
                <button onclick="loginWithTestAccount()">Login with Test Account</button>
            `;
        }
        
        async function loginWithTestAccount() {
            try {
                const testEmail = "test@nightvibe.com";
                const testPassword = "test123";
                
                await firebase.auth().signInWithEmailAndPassword(testEmail, testPassword);
                console.log("Logged in with test account");
            } catch (error) {
                console.log("Test login failed:", error.message);
                alert("Test login failed: " + error.message);
            }
        }
        
        function logout() {
            firebase.auth().signOut();
            location.reload();
        }
        
        async function sendTestMessage() {
            const receiverId = document.getElementById('testUserId').value.trim();
            const messageText = document.getElementById('testMessage').value.trim();
            const resultDiv = document.getElementById('sendResult');
            
            if (!receiverId || !messageText) {
                resultDiv.innerHTML = '<p class="error">Please enter both receiver ID and message</p>';
                return;
            }
            
            if (!currentUser) {
                resultDiv.innerHTML = '<p class="error">No user logged in</p>';
                return;
            }
            
            if (!db) {
                resultDiv.innerHTML = '<p class="error">Database not initialized</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Sending test message...</p>';
            
            try {
                console.log("Sending test message...");
                console.log("From:", currentUser.uid);
                console.log("To:", receiverId);
                console.log("Message:", messageText);
                
                // Send message using the SAME structure as your app
                const messageData = {
                    content: messageText,  // Primary content field
                    message: messageText,   // Backup field for compatibility
                    senderId: currentUser.uid,
                    receiverId: receiverId,
                    participants: [currentUser.uid, receiverId],  // Required for queries
                    isAnonymous: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    readBy: [currentUser.uid],  // Mark as read by sender
                    read: false  // Legacy field
                };
                
                const result = await db.collection("messages").add(messageData);
                
                console.log("✅ Message sent successfully! ID:", result.id);
                resultDiv.innerHTML = `
                    <p class="success">✅ Message sent successfully!</p>
                    <p>Document ID: ${result.id}</p>
                    <p>Structure used:</p>
                    <pre>${JSON.stringify(messageData, null, 2)}</pre>
                `;
                
                // Refresh messages view
                setTimeout(() => checkMyMessages(), 1000);
                
            } catch (error) {
                console.error("Error sending test message:", error);
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function checkAllMessages() {
            try {
                const container = document.getElementById('allMessages');
                container.innerHTML = '<p>Loading all messages...</p>';
                
                const snapshot = await db.collection("messages").get();
                
                container.innerHTML = `<h3>Total Messages in Database: ${snapshot.size}</h3>`;
                
                if (snapshot.empty) {
                    container.innerHTML += "<p class='error'>❌ No messages in database!</p>";
                    return;
                }
                
                // Display all messages
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? 
                        data.timestamp.toDate().toLocaleString() : 
                        'No timestamp';
                    
                    container.innerHTML += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f9f9f9;">
                            <strong>Message #${index + 1}:</strong> ${doc.id}<br>
                            <strong>Timestamp:</strong> ${timestamp}<br>
                            <strong>Sender:</strong> ${data.senderId || 'No sender'}<br>
                            <strong>Receiver:</strong> ${data.receiverId || 'No receiver'}<br>
                            <strong>Content:</strong> ${data.content || data.message || 'No content'}<br>
                            <strong>Has participants:</strong> ${data.participants ? 'Yes (' + data.participants.join(', ') + ')' : 'No'}<br>
                            <strong>Read by:</strong> ${data.readBy ? data.readBy.join(', ') : 'None'}<br>
                            <button onclick="viewMessageDetails('${doc.id}')" style="margin-top: 5px;">View Details</button>
                            <div id="details-${doc.id}" style="display: none; margin-top: 10px; padding: 10px; background: #eee;">
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Error checking messages:", error);
                document.getElementById('allMessages').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        function viewMessageDetails(messageId) {
            const detailsDiv = document.getElementById(`details-${messageId}`);
            if (detailsDiv) {
                detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        async function checkMyMessages() {
            if (!currentUser) {
                document.getElementById('myMessages').innerHTML = '<p class="error">No user logged in</p>';
                return;
            }
            
            try {
                const container = document.getElementById('myMessages');
                container.innerHTML = '<p>Loading your messages...</p>';
                
                const userId = currentUser.uid;
                console.log(`Checking messages for user: ${userId}`);
                
                // Try different query methods to see what works
                container.innerHTML = `<h3>Messages for: ${userId}</h3>`;
                
                // Method 1: Where I'm receiver
                try {
                    const receivedSnapshot = await db.collection("messages")
                        .where("receiverId", "==", userId)
                        .get();
                    
                    container.innerHTML += `<h4>Received Messages: ${receivedSnapshot.size}</h4>`;
                    
                    if (receivedSnapshot.empty) {
                        container.innerHTML += "<p>No messages where you are receiver</p>";
                    } else {
                        receivedSnapshot.forEach(doc => {
                            const data = doc.data();
                            container.innerHTML += `
                                <div style="border-left: 4px solid green; padding: 5px; margin: 5px 0;">
                                    <strong>From:</strong> ${data.senderId}<br>
                                    <strong>Message:</strong> ${data.content || data.message}<br>
                                    <strong>Time:</strong> ${data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : ''}
                                </div>
                            `;
                        });
                    }
                } catch (error) {
                    container.innerHTML += `<p class="error">Error querying received: ${error.message}</p>`;
                }
                
                // Method 2: Where I'm sender
                try {
                    const sentSnapshot = await db.collection("messages")
                        .where("senderId", "==", userId)
                        .get();
                    
                    container.innerHTML += `<h4>Sent Messages: ${sentSnapshot.size}</h4>`;
                    
                    if (sentSnapshot.empty) {
                        container.innerHTML += "<p>No messages where you are sender</p>";
                    } else {
                        sentSnapshot.forEach(doc => {
                            const data = doc.data();
                            container.innerHTML += `
                                <div style="border-left: 4px solid blue; padding: 5px; margin: 5px 0;">
                                    <strong>To:</strong> ${data.receiverId}<br>
                                    <strong>Message:</strong> ${data.content || data.message}<br>
                                    <strong>Time:</strong> ${data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : ''}
                                </div>
                            `;
                        });
                    }
                } catch (error) {
                    container.innerHTML += `<p class="error">Error querying sent: ${error.message}</p>`;
                }
                
                // Method 3: Using participants array
                try {
                    const participantSnapshot = await db.collection("messages")
                        .where("participants", "array-contains", userId)
                        .get();
                    
                    container.innerHTML += `<h4>Messages with participants array: ${participantSnapshot.size}</h4>`;
                    
                    if (participantSnapshot.empty) {
                        container.innerHTML += "<p>No messages with participants array containing you</p>";
                    } else {
                        participantSnapshot.forEach(doc => {
                            const data = doc.data();
                            container.innerHTML += `
                                <div style="border-left: 4px solid orange; padding: 5px; margin: 5px 0;">
                                    <strong>Participants:</strong> ${data.participants ? data.participants.join(', ') : 'None'}<br>
                                    <strong>Message:</strong> ${data.content || data.message}<br>
                                </div>
                            `;
                        });
                    }
                } catch (error) {
                    container.innerHTML += `<p class="error">Error querying participants: ${error.message}</p>`;
                }
                
            } catch (error) {
                console.error("Error checking my messages:", error);
                document.getElementById('myMessages').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function createTestMessage() {
            try {
                const container = document.getElementById('testMessageResult');
                container.innerHTML = '<p>Creating test message...</p>';
                
                // First, get or create two test users
                const user1 = await getOrCreateTestUser("test1@nightvibe.com", "TestUser1");
                const user2 = await getOrCreateTestUser("test2@nightvibe.com", "TestUser2");
                
                // Create a message from user1 to user2
                const messageData = {
                    content: "This is a test message from TestUser1 to TestUser2",
                    message: "This is a test message from TestUser1 to TestUser2",
                    senderId: user1.uid,
                    receiverId: user2.uid,
                    participants: [user1.uid, user2.uid],
                    isAnonymous: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    readBy: [user1.uid],
                    read: false
                };
                
                const result = await db.collection("messages").add(messageData);
                
                container.innerHTML = `
                    <p class="success">✅ Test message created successfully!</p>
                    <p><strong>From:</strong> TestUser1 (${user1.uid})</p>
                    <p><strong>To:</strong> TestUser2 (${user2.uid})</p>
                    <p><strong>Message ID:</strong> ${result.id}</p>
                    <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                `;
                
                // Refresh messages view
                setTimeout(() => checkAllMessages(), 1000);
                
            } catch (error) {
                console.error("Error creating test message:", error);
                document.getElementById('testMessageResult').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function getOrCreateTestUser(email, username) {
            try {
                // Try to sign in
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, "test123");
                return userCredential.user;
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    // Create new user
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, "test123");
                    
                    // Create user profile
                    await db.collection("users").doc(userCredential.user.uid).set({
                        username: username,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isAdmin: false,
                        photos: [],
                        status: "online",
                        stats: {
                            age: 25,
                            position: "V",
                            relationshipStatus: "Single"
                        }
                    });
                    
                    return userCredential.user;
                } else {
                    throw error;
                }
            }
        }
        
        async function checkAllUsers() {
            try {
                const container = document.getElementById('allUsers');
                container.innerHTML = '<p>Loading users...</p>';
                
                const snapshot = await db.collection("users").get();
                
                container.innerHTML = `<h3>Total Users: ${snapshot.size}</h3>`;
                
                if (snapshot.empty) {
                    container.innerHTML += "<p>No users in database</p>";
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    container.innerHTML += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                            <strong>User ID:</strong> ${doc.id}<br>
                            <strong>Username:</strong> ${data.username || 'No username'}<br>
                            <strong>Email:</strong> ${data.email || 'No email'}<br>
                            <strong>Photos:</strong> ${data.photos ? data.photos.length : 0}<br>
                            <button onclick="setReceiverId('${doc.id}')">Send Message to This User</button>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Error checking users:", error);
                document.getElementById('allUsers').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        function setReceiverId(userId) {
            document.getElementById('testUserId').value = userId;
            document.getElementById('testMessage').value = "Hello! This is a test message.";
        }
    </script>
</body>
</html>